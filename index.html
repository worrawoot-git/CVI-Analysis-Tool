<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVI Analysis Tool v3.0 (Dynamic Editor)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .step-active { color: #1d4ed8; border-bottom: 3px solid #1d4ed8; font-weight: bold; }
        .cell-input::-webkit-inner-spin-button, .cell-input::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-6xl mx-auto bg-white shadow-2xl rounded-3xl overflow-hidden border border-gray-100">
        <div class="bg-gradient-to-r from-slate-800 to-blue-900 p-6 text-white flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">CVI Analysis Tool <span class="text-blue-400 text-sm font-normal">v3.0 Dynamic</span></h1>
                <p class="text-slate-300 text-xs mt-1">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏¥‡∏™‡∏£‡∏∞‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å Polit & Beck (2006)</p>
            </div>
            <div class="text-right no-print">
                <button onclick="location.reload()" class="text-xs bg-white/10 hover:bg-white/20 px-3 py-1 rounded border border-white/20 transition">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
        </div>

        <div class="p-6">
            
            <div id="setup-area" class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-4 rounded-2xl border border-gray-200 no-print">
                <div class="flex items-center gap-4">
                    <label class="font-bold text-gray-700 whitespace-nowrap">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç:</label>
                    <div class="flex items-center border-2 border-blue-200 rounded-lg bg-white overflow-hidden">
                        <button onclick="updateExperts(-1)" class="px-3 py-1 bg-gray-100 hover:bg-red-100 text-red-600 font-bold">-</button>
                        <input type="number" id="expert-count" value="3" min="3" max="20" class="w-12 text-center font-bold outline-none" readonly>
                        <button onclick="updateExperts(1)" class="px-3 py-1 bg-gray-100 hover:bg-green-100 text-green-600 font-bold">+</button>
                    </div>
                </div>
                <div class="flex items-center justify-end gap-2">
                    <button onclick="pasteExcel()" class="bg-emerald-50 text-emerald-700 border border-emerald-200 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-emerald-100 transition flex items-center gap-1">
                        üìã ‡∏ß‡∏≤‡∏á‡∏à‡∏≤‡∏Å Excel
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-sm mb-6">
                <table class="w-full text-left border-collapse" id="main-table">
                    <thead class="bg-slate-100 text-slate-600 text-xs uppercase">
                        <tr id="thr">
                            <th class="p-3 border-r w-16 text-center">Item</th>
                            <th class="p-3 text-center w-20 no-print">‡∏•‡∏ö</th>
                        </tr>
                    </thead>
                    <tbody id="tbr" class="text-sm">
                        </tbody>
                </table>
            </div>

            <button onclick="addRow()" class="no-print w-full py-3 mb-8 border-2 border-dashed border-blue-300 rounded-xl text-blue-600 font-bold hover:bg-blue-50 transition flex items-center justify-center gap-2">
                <span>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (Add New Item)</span>
            </button>

            <div class="flex flex-col gap-8">
                <div class="text-center no-print">
                    <button onclick="processCVI()" class="bg-blue-600 hover:bg-blue-700 text-white px-12 py-4 rounded-2xl font-bold text-lg shadow-xl shadow-blue-200 transform hover:scale-105 transition">
                        ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏• CVI
                    </button>
                </div>

                <div id="results-area" class="hidden space-y-6">
                    <hr class="border-t-2 border-dashed border-gray-200">
                    
                    <div id="stat-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>

                    <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm">
                        <table class="w-full text-center">
                            <thead class="bg-slate-800 text-white text-sm">
                                <tr>
                                    <th class="p-3">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà</th>
                                    <th class="p-3">‡πÄ‡∏´‡πá‡∏ô‡∏û‡πâ‡∏≠‡∏á (3-4)</th>
                                    <th class="p-3">I-CVI</th>
                                    <th class="p-3">95% CI</th>
                                    <th class="p-3">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤</th>
                                </tr>
                            </thead>
                            <tbody id="res-body" class="divide-y"></tbody>
                        </table>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 no-print">
                        <button onclick="exportToExcel()" class="bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-emerald-700">üì• Export Excel</button>
                        <button onclick="window.print()" class="bg-slate-700 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-black">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentExperts = 3;
        let rowCount = 0;

        // Initialize with 5 rows
        window.onload = () => {
            renderHeaders();
            for(let i=0; i<5; i++) addRow();
        };

        function renderHeaders() {
            const thr = document.getElementById('thr');
            let html = '<th class="p-3 border-r w-16 text-center">Item</th>';
            for(let i=1; i<=currentExperts; i++) {
                html += `<th class="p-3 text-center bg-blue-50/50">Exp ${i}</th>`;
            }
            html += '<th class="p-3 text-center w-20 no-print">‡∏•‡∏ö</th>';
            thr.innerHTML = html;
        }

        function updateExperts(val) {
            const newCount = currentExperts + val;
            if(newCount < 3 || newCount > 20) return;
            
            currentExperts = newCount;
            document.getElementById('expert-count').value = currentExperts;
            
            // Refresh table to match expert count
            const rowsData = [];
            document.querySelectorAll('#tbr tr').forEach(tr => {
                const rowVals = [];
                tr.querySelectorAll('.cell-input').forEach(input => rowVals.push(input.value));
                rowsData.push(rowVals);
            });

            renderHeaders();
            const b = document.getElementById('tbr');
            b.innerHTML = '';
            rowCount = 0;
            rowsData.forEach(data => addRow(data));
        }

        function addRow(existingData = []) {
            rowCount++;
            const b = document.getElementById('tbr');
            const tr = document.createElement('tr');
            tr.className = "border-b hover:bg-blue-50/30 transition group";
            tr.id = `row-${rowCount}`;

            let html = `<td class="p-3 font-bold border-r bg-gray-50 text-center item-index">${rowCount}</td>`;
            for(let i=1; i<=currentExperts; i++) {
                const val = existingData[i-1] || '';
                html += `<td class="p-1"><input type="number" min="1" max="4" value="${val}" class="cell-input w-full text-center py-2 bg-transparent outline-none focus:bg-white rounded border border-transparent focus:border-blue-300"></td>`;
            }
            html += `<td class="p-3 text-center no-print">
                        <button onclick="removeRow('${tr.id}')" class="text-red-300 hover:text-red-600 font-bold transition">‚úï</button>
                     </td>`;
            
            tr.innerHTML = html;
            b.appendChild(tr);
            reIndex();
        }

        function removeRow(id) {
            const row = document.getElementById(id);
            if(document.querySelectorAll('#tbr tr').length <= 1) return alert("‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°");
            row.remove();
            reIndex();
        }

        function reIndex() {
            document.querySelectorAll('.item-index').forEach((td, idx) => {
                td.innerText = idx + 1;
            });
        }

        async function pasteExcel() {
            const text = await navigator.clipboard.readText();
            const lines = text.trim().split(/\r?\n/);
            const b = document.getElementById('tbr');
            b.innerHTML = '';
            rowCount = 0;
            
            lines.forEach(line => {
                const vals = line.split('\t');
                addRow(vals);
            });
        }

        let excelData = [];
        function processCVI() {
            const rows = document.querySelectorAll('#tbr tr');
            let itemCVIs = [];
            let uaTotal = 0;
            let resHtml = '';
            excelData = [];

            const crit = currentExperts <= 5 ? 1.00 : 0.78;

            for(let i=0; i<rows.length; i++) {
                const inputs = rows[i].querySelectorAll('.cell-input');
                let scores = [];
                let hasEmpty = false;
                
                inputs.forEach(input => {
                    if(!input.value) hasEmpty = true;
                    scores.push(parseInt(input.value));
                });

                if(hasEmpty) return alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${i+1} ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á`);

                const agreed = scores.filter(s => s >= 3).length;
                const icvi = agreed / currentExperts;
                const isUA = agreed === currentExperts ? 1 : 0;
                uaTotal += isUA;
                itemCVIs.push(icvi);

                // 95% CI
                const z = 1.96;
                const low = (2*agreed + z*z - z*Math.sqrt(z*z + 4*agreed*(1-icvi))) / (2*(currentExperts + z*z));
                const high = (2*agreed + z*z + z*Math.sqrt(z*z + 4*agreed*(1-icvi))) / (2*(currentExperts + z*z));

                const isPass = icvi >= crit;
                resHtml += `
                    <tr class="${isPass ? '' : 'bg-red-50'}">
                        <td class="p-3 font-medium">${i+1}</td>
                        <td class="p-3">${agreed}</td>
                        <td class="p-3 font-bold ${isPass ? 'text-green-600' : 'text-red-600'}">${icvi.toFixed(3)}</td>
                        <td class="p-3 text-xs text-gray-400">${low.toFixed(2)} - ${high.toFixed(2)}</td>
                        <td class="p-3">${isPass ? '‚úÖ ‡∏ú‡πà‡∏≤‡∏ô' : '‚ùå ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á'}</td>
                    </tr>`;
                
                excelData.push({ "Item": i+1, "Agreed": agreed, "I-CVI": icvi.toFixed(3), "CI_Low": low.toFixed(2), "CI_High": high.toFixed(2), "Status": isPass ? "Pass" : "Revise" });
            }

            const aveCVI = itemCVIs.reduce((a,b) => a+b) / itemCVIs.length;
            const uaCVI = uaTotal / itemCVIs.length;

            document.getElementById('stat-cards').innerHTML = `
                <div class="bg-blue-600 p-4 rounded-xl text-white text-center shadow-lg shadow-blue-100">
                    <p class="text-[10px] uppercase font-bold opacity-80">S-CVI/Ave</p>
                    <p class="text-3xl font-black">${aveCVI.toFixed(3)}</p>
                </div>
                <div class="bg-indigo-600 p-4 rounded-xl text-white text-center shadow-lg shadow-indigo-100">
                    <p class="text-[10px] uppercase font-bold opacity-80">S-CVI/UA</p>
                    <p class="text-3xl font-black">${uaCVI.toFixed(3)}</p>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl text-white text-center">
                    <p class="text-[10px] uppercase font-bold opacity-80">Acceptance Crit.</p>
                    <p class="text-3xl font-black">‚â• ${crit.toFixed(2)}</p>
                </div>
            `;

            document.getElementById('res-body').innerHTML = resHtml;
            document.getElementById('results-area').classList.remove('hidden');
            window.scrollTo({ top: document.getElementById('results-area').offsetTop, behavior: 'smooth' });
        }

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "CVI_Summary");
            XLSX.writeFile(wb, "CVI_Research_Analysis.xlsx");
        }
    </script>
</body>
</html>
