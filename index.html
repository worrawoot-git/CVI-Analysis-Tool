<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVI Analysis Tool v2.0 (Professional Export)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .step-active { color: #1d4ed8; border-bottom: 3px solid #1d4ed8; font-weight: bold; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-5xl mx-auto bg-white shadow-2xl rounded-3xl overflow-hidden border border-gray-100">
        <div class="bg-gradient-to-r from-blue-800 to-indigo-900 p-8 text-white">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold tracking-tight">CVI Analysis Tool</h1>
                    <p class="text-blue-200 text-sm mt-2 opacity-90">‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏á‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå (Updated 2024)</p>
                </div>
                <div class="hidden md:block text-right">
                    <span class="bg-blue-500/30 text-xs px-3 py-1 rounded-full border border-blue-400">Academic Standard</span>
                </div>
            </div>
        </div>

        <div class="flex justify-around bg-gray-50 border-b overflow-x-auto">
            <div id="s1-lbl" class="py-4 px-6 text-sm step-active">1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
            <div id="s2-lbl" class="py-4 px-6 text-sm text-gray-400">2. ‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
            <div id="s3-lbl" class="py-4 px-6 text-sm text-gray-400">3. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</div>
            <div id="s4-lbl" class="py-4 px-6 text-sm text-gray-400">4. ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå & Export</div>
        </div>

        <div class="p-8">
            <div id="step1" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-2">
                        <label class="block font-semibold text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç (Experts)</label>
                        <input type="number" id="experts" min="3" max="20" value="5" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none transition">
                        <p class="text-xs text-amber-600 font-medium">üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ 3-10 ‡∏Ñ‡∏ô ‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ç‡∏≠‡∏á Lynn (1986)</p>
                    </div>
                    <div class="space-y-2">
                        <label class="block font-semibold text-gray-700">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (Items)</label>
                        <input type="number" id="items" min="1" value="10" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none transition">
                    </div>
                </div>
                <button onclick="initTable()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transform hover:-translate-y-1 transition">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>

            <div id="step2" class="hidden">
                <div class="flex flex-col md:flex-row justify-between items-end mb-4 gap-4">
                    <div>
                        <h3 class="font-bold text-lg">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
                        <p class="text-sm text-gray-500">‡∏£‡∏∞‡∏î‡∏±‡∏ö 3-4 = ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á | ‡∏£‡∏∞‡∏î‡∏±‡∏ö 1-2 = ‡πÑ‡∏°‡πà‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="pasteExcel()" class="bg-green-50 text-green-700 border border-green-200 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-100">üìã ‡∏ß‡∏≤‡∏á‡∏à‡∏≤‡∏Å Excel</button>
                    </div>
                </div>
                <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-sm">
                    <table class="w-full text-left border-collapse" id="inputGrid">
                        <thead class="bg-gray-100 text-gray-600 text-xs uppercase">
                            <tr id="hRow"></tr>
                        </thead>
                        <tbody id="bRow" class="text-sm"></tbody>
                    </table>
                </div>
                <div class="mt-8 flex gap-4 no-print">
                    <button onclick="showStep(1)" class="flex-1 py-3 border-2 border-gray-200 rounded-xl font-bold text-gray-500">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                    <button onclick="processCVI()" class="flex-[2] py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700">‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏ó‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</button>
                </div>
            </div>

            <div id="step4" class="hidden">
                <div id="summaryCards" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    </div>

                <div class="border rounded-2xl overflow-hidden mb-6">
                    <table class="w-full text-center" id="resultTable">
                        <thead class="bg-slate-800 text-white">
                            <tr>
                                <th class="p-3 text-sm">Item</th>
                                <th class="p-3 text-sm">Agreed (3-4)</th>
                                <th class="p-3 text-sm">I-CVI</th>
                                <th class="p-3 text-sm">95% CI</th>
                                <th class="p-3 text-sm">‡∏™‡∏£‡∏∏‡∏õ</th>
                            </tr>
                        </thead>
                        <tbody id="resBody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>

                <div class="bg-blue-50 p-5 rounded-2xl border border-blue-100 mb-8">
                    <h4 class="font-bold text-blue-900 mb-2 underline">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤:</h4>
                    <ul class="text-sm text-blue-800 space-y-1 list-disc pl-5" id="adviceList"></ul>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 no-print">
                    <button onclick="exportToExcel()" class="bg-emerald-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-emerald-700 flex items-center justify-center gap-2">
                        üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx)
                    </button>
                    <button onclick="window.print()" class="bg-gray-800 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-black flex items-center justify-center gap-2">
                        üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏õ‡πá‡∏ô PDF / ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let nExp, nItem;
        let finalData = [];

        function showStep(n) {
            document.querySelectorAll('[id^="step"]').forEach(s => s.classList.add('hidden'));
            document.getElementById('step'+n).classList.remove('hidden');
            document.querySelectorAll('[id$="-lbl"]').forEach((l, idx) => {
                l.classList.toggle('step-active', idx + 1 === n);
            });
        }

        function initTable() {
            nExp = parseInt(document.getElementById('experts').value);
            nItem = parseInt(document.getElementById('items').value);
            
            if(nExp < 3) return alert("‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç 3 ‡∏Ñ‡∏ô");

            const h = document.getElementById('hRow');
            const b = document.getElementById('bRow');
            
            h.innerHTML = '<th class="p-3 border-r">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà</th>';
            for(let i=1; i<=nExp; i++) h.innerHTML += `<th class="p-3 text-center">Exp ${i}</th>`;

            b.innerHTML = '';
            for(let i=1; i<=nItem; i++) {
                let r = `<tr class="border-b hover:bg-blue-50/50"><td class="p-3 font-bold border-r bg-gray-50 text-center">${i}</td>`;
                for(let j=1; j<=nExp; j++) {
                    r += `<td class="p-1"><input type="number" min="1" max="4" class="cell w-full text-center py-2 bg-transparent outline-none focus:bg-white" data-r="${i}" data-c="${j}"></td>`;
                }
                b.innerHTML += r + `</tr>`;
            }
            showStep(2);
        }

        async function pasteExcel() {
            const text = await navigator.clipboard.readText();
            const lines = text.trim().split(/\r?\n/);
            const cells = document.querySelectorAll('.cell');
            let idx = 0;
            lines.forEach(line => {
                line.split('\t').forEach(val => {
                    if(cells[idx]) {
                        let v = parseInt(val);
                        if(v >= 1 && v <= 4) cells[idx].value = v;
                        idx++;
                    }
                });
            });
        }

        function processCVI() {
            const cells = document.querySelectorAll('.cell');
            let matrix = Array.from({length: nItem}, () => []);
            let incomplete = false;

            cells.forEach(c => {
                if(!c.value) incomplete = true;
                matrix[c.dataset.r - 1].push(parseInt(c.value));
            });

            if(incomplete) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á");

            const crit = nExp <= 5 ? 1.00 : 0.78;
            let uaCount = 0;
            let iCVIList = [];
            let rowsHtml = '';
            finalData = []; // Reset for excel

            matrix.forEach((row, i) => {
                const agreed = row.filter(v => v >= 3).length;
                const icvi = agreed / nExp;
                const ua = (agreed === nExp) ? 1 : 0;
                uaCount += ua;
                iCVIList.push(icvi);

                // 95% CI (Wilson Score)
                const z = 1.96;
                const low = (2*agreed + z*z - z*Math.sqrt(z*z + 4*agreed*(1-icvi))) / (2*(nExp + z*z));
                const high = (2*agreed + z*z + z*Math.sqrt(z*z + 4*agreed*(1-icvi))) / (2*(nExp + z*z));

                const pass = icvi >= crit;
                rowsHtml += `
                    <tr class="${pass ? '' : 'bg-red-50'}">
                        <td class="p-3 font-medium">${i+1}</td>
                        <td class="p-3">${agreed}</td>
                        <td class="p-3 font-bold ${pass ? 'text-green-600' : 'text-red-600'}">${icvi.toFixed(3)}</td>
                        <td class="p-3 text-gray-500 text-xs">${low.toFixed(2)} - ${high.toFixed(2)}</td>
                        <td class="p-3">${pass ? '‚úÖ ‡∏ú‡πà‡∏≤‡∏ô' : '‚ùå ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á'}</td>
                    </tr>`;
                
                finalData.push({ "Item": i+1, "Agreed": agreed, "I-CVI": icvi.toFixed(3), "CI_Lower": low.toFixed(2), "CI_Upper": high.toFixed(2), "Result": pass ? 'Pass' : 'Revise' });
            });

            const aveCVI = iCVIList.reduce((a,b) => a+b) / nItem;
            const uaCVI = uaCount / nItem;

            document.getElementById('summaryCards').innerHTML = `
                <div class="bg-white p-6 border-2 border-blue-600 rounded-2xl shadow-sm text-center">
                    <p class="text-blue-600 text-xs font-bold uppercase mb-1">S-CVI / Average</p>
                    <p class="text-4xl font-black text-slate-800">${aveCVI.toFixed(3)}</p>
                </div>
                <div class="bg-white p-6 border-2 border-indigo-600 rounded-2xl shadow-sm text-center">
                    <p class="text-indigo-600 text-xs font-bold uppercase mb-1">S-CVI / UA</p>
                    <p class="text-4xl font-black text-slate-800">${uaCVI.toFixed(3)}</p>
                </div>
                <div class="bg-white p-6 border-2 border-slate-200 rounded-2xl shadow-sm text-center">
                    <p class="text-gray-500 text-xs font-bold uppercase mb-1">Lynn's Cut-off</p>
                    <p class="text-4xl font-black text-slate-800">‚â• ${crit.toFixed(2)}</p>
                </div>
            `;

            document.getElementById('resBody').innerHTML = rowsHtml;
            document.getElementById('adviceList').innerHTML = `
                <li>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç ${nExp} ‡∏Ñ‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤ I-CVI ‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ ${crit} (Lynn, 1986)</li>
                <li>‡∏Ñ‡πà‡∏≤ S-CVI/Ave ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏â‡∏ö‡∏±‡∏ö‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ ‚â• 0.90 (Polit & Beck, 2006)</li>
                <li>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏°: ${aveCVI >= 0.9 ? '<span class="font-bold text-green-600">‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°</span>' : '<span class="font-bold text-red-600">‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ö‡∏≤‡∏á‡∏Ç‡πâ‡∏≠</span>'}</li>
            `;

            showStep(4);
        }

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(finalData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "CVI_Analysis_Report");
            XLSX.writeFile(wb, "CVI_Report_Analysis.xlsx");
        }
    </script>
</body>
</html>
