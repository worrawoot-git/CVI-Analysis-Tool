<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVI Analysis Tool v2.1 (Dynamic Rows)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f1f5f9; }
        .step-active { color: #1d4ed8; border-bottom: 3px solid #1d4ed8; font-weight: bold; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-5xl mx-auto bg-white shadow-2xl rounded-3xl overflow-hidden border border-gray-100">
        <div class="bg-gradient-to-r from-blue-800 to-indigo-900 p-8 text-white">
            <h1 class="text-3xl font-bold tracking-tight">CVI Analysis Tool</h1>
            <p class="text-blue-200 text-sm mt-2 opacity-90">‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á: ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡πÑ‡∏î‡πâ‡∏≠‡∏¥‡∏™‡∏£‡∏∞</p>
        </div>

        <div class="flex justify-around bg-gray-50 border-b overflow-x-auto no-print">
            <div id="s1-lbl" class="py-4 px-6 text-sm step-active">1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</div>
            <div id="s2-lbl" class="py-4 px-6 text-sm text-gray-400">2. ‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
            <div id="s3-lbl" class="py-4 px-6 text-sm text-gray-400">3. ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• & Export</div>
        </div>

        <div class="p-8">
            <div id="step1" class="space-y-6">
                <div class="max-w-md mx-auto space-y-4">
                    <label class="block font-semibold text-gray-700">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç (Experts)</label>
                    <input type="number" id="experts" min="3" max="20" value="5" class="w-full p-3 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none transition">
                    <p class="text-xs text-amber-600 font-medium italic">‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå Lynn (1986) ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏Ñ‡∏ô</p>
                    <button onclick="initTable()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
                </div>
            </div>

            <div id="step2" class="hidden">
                <div class="flex flex-col md:flex-row justify-between items-end mb-4 gap-4">
                    <div>
                        <h3 class="font-bold text-lg text-blue-800">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
                        <p class="text-xs text-gray-500">‡∏£‡∏∞‡∏î‡∏±‡∏ö 1-4 (3-4 ‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ)</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="pasteExcel()" class="bg-emerald-50 text-emerald-700 border border-emerald-200 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-emerald-100">üìã ‡∏ß‡∏≤‡∏á‡∏à‡∏≤‡∏Å Excel</button>
                    </div>
                </div>

                <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-sm">
                    <table class="w-full text-left border-collapse" id="inputGrid">
                        <thead class="bg-gray-100 text-gray-600 text-xs uppercase">
                            <tr id="hRow"></tr>
                        </thead>
                        <tbody id="bRow" class="text-sm"></tbody>
                    </table>
                </div>

                <div class="mt-4 flex gap-2">
                    <button onclick="addNewRow()" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-200 transition">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß (Add Row)</button>
                    <button onclick="removeLastRow()" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-100 transition">‚ûñ ‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</button>
                </div>

                <div class="mt-8 flex gap-4 no-print">
                    <button onclick="showStep(1)" class="flex-1 py-3 border-2 border-gray-200 rounded-xl font-bold text-gray-500">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                    <button onclick="processCVI()" class="flex-[2] py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</button>
                </div>
            </div>

            <div id="step3" class="hidden">
                <div id="summaryCards" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"></div>

                <div class="border rounded-2xl overflow-hidden mb-6 shadow-sm">
                    <table class="w-full text-center" id="resultTable">
                        <thead class="bg-slate-800 text-white">
                            <tr>
                                <th class="p-3 text-xs uppercase">Item</th>
                                <th class="p-3 text-xs uppercase">Agreed (3-4)</th>
                                <th class="p-3 text-xs uppercase">I-CVI</th>
                                <th class="p-3 text-xs uppercase">95% CI</th>
                                <th class="p-3 text-xs uppercase">‡∏ú‡∏•‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤</th>
                            </tr>
                        </thead>
                        <tbody id="resBody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>

                <div class="bg-blue-50 p-5 rounded-2xl border border-blue-100 mb-8">
                    <h4 class="font-bold text-blue-900 mb-2">‡∏ö‡∏ó‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£:</h4>
                    <ul class="text-sm text-blue-800 space-y-1 list-disc pl-5" id="adviceList"></ul>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 no-print">
                    <button onclick="exportToExcel()" class="bg-emerald-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-emerald-700">üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel (.xlsx)</button>
                    <button onclick="window.print()" class="bg-gray-800 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-black">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                </div>
                <button onclick="location.reload()" class="w-full mt-6 text-gray-400 text-xs underline no-print">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div>
    </div>

    <script>
        let nExp;
        let finalData = [];

        function showStep(n) {
            document.querySelectorAll('[id^="step"]').forEach(s => s.classList.add('hidden'));
            document.getElementById('step'+n).classList.remove('hidden');
            document.querySelectorAll('[id$="-lbl"]').forEach((l, idx) => {
                l.classList.toggle('step-active', idx + 1 === (n == 3 ? 3 : n));
            });
        }

        function initTable() {
            nExp = parseInt(document.getElementById('experts').value);
            if(nExp < 3) return alert("‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏Ñ‡∏ô");

            const h = document.getElementById('hRow');
            h.innerHTML = '<th class="p-3 border-r">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà</th>';
            for(let i=1; i<=nExp; i++) h.innerHTML += `<th class="p-3 text-center">E${i}</th>`;

            document.getElementById('bRow').innerHTML = '';
            for(let i=0; i<5; i++) addNewRow(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà 5 ‡∏Ç‡πâ‡∏≠
            showStep(2);
        }

        function addNewRow() {
            const b = document.getElementById('bRow');
            const rowCount = b.rows.length + 1;
            const tr = document.createElement('tr');
            tr.className = "border-b hover:bg-blue-50/50 transition";
            
            let html = `<td class="p-3 font-bold border-r bg-gray-50 text-center item-num">${rowCount}</td>`;
            for(let j=1; j<=nExp; j++) {
                html += `<td class="p-1"><input type="number" min="1" max="4" class="cell w-full text-center py-2 bg-transparent outline-none focus:bg-white border-b border-transparent focus:border-blue-400"></td>`;
            }
            tr.innerHTML = html;
            b.appendChild(tr);
        }

        function removeLastRow() {
            const b = document.getElementById('bRow');
            if(b.rows.length > 1) b.deleteRow(-1);
        }

        async function pasteExcel() {
            const text = await navigator.clipboard.readText();
            const lines = text.trim().split(/\r?\n/);
            const b = document.getElementById('bRow');
            b.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤
            
            lines.forEach((line, idx) => {
                addNewRow();
                const inputs = b.rows[idx].querySelectorAll('input');
                const vals = line.split('\t');
                vals.forEach((v, vIdx) => {
                    if(inputs[vIdx]) inputs[vIdx].value = v.trim();
                });
            });
        }

        function processCVI() {
            const rows = document.querySelectorAll('#bRow tr');
            let itemCVIs = [];
            let uaCount = 0;
            let resHtml = '';
            finalData = [];

            const crit = nExp <= 5 ? 1.00 : 0.78;

            for(let i=0; i<rows.length; i++) {
                const inputs = rows[i].querySelectorAll('input');
                let scores = [];
                let hasEmpty = false;
                
                inputs.forEach(input => {
                    if(!input.value) hasEmpty = true;
                    scores.push(parseInt(input.value));
                });

                if(hasEmpty) return alert(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${i+1} ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì`);

                const agreed = scores.filter(v => v >= 3).length;
                const icvi = agreed / nExp;
                const ua = (agreed === nExp) ? 1 : 0;
                uaCount += ua;
                itemCVIs.push(icvi);

                // Wilson Score Interval 95%
                const z = 1.96;
                const low = (2*agreed + z*z - z*Math.sqrt(z*z + 4*agreed*(1-icvi))) / (2*(nExp + z*z));
                const high = (2*agreed + z*z + z*Math.sqrt(z*z + 4*agreed*(1-icvi))) / (2*(nExp + z*z));

                const pass = icvi >= crit;
                resHtml += `<tr class="${pass ? '' : 'bg-red-50 text-red-700'}">
                    <td class="p-3 font-medium">${i+1}</td>
                    <td class="p-3">${agreed}</td>
                    <td class="p-3 font-bold">${icvi.toFixed(3)}</td>
                    <td class="p-3 text-xs opacity-70">${low.toFixed(2)} - ${high.toFixed(2)}</td>
                    <td class="p-3 font-semibold">${pass ? '‚úÖ ‡∏ú‡πà‡∏≤‡∏ô' : '‚ùå ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á'}</td>
                </tr>`;
                
                finalData.push({ "Item": i+1, "Agreed": agreed, "I-CVI": icvi.toFixed(3), "CI_Low": low.toFixed(2), "CI_High": high.toFixed(2), "Status": pass ? "Pass" : "Revise" });
            }

            const aveCVI = itemCVIs.reduce((a,b) => a+b) / itemCVIs.length;
            const uaCVI = uaCount / itemCVIs.length;

            document.getElementById('summaryCards').innerHTML = `
                <div class="bg-white p-5 border-2 border-blue-600 rounded-2xl text-center">
                    <p class="text-blue-600 text-[10px] font-bold uppercase">S-CVI / Average</p>
                    <p class="text-3xl font-black">${aveCVI.toFixed(3)}</p>
                </div>
                <div class="bg-white p-5 border-2 border-indigo-600 rounded-2xl text-center">
                    <p class="text-indigo-600 text-[10px] font-bold uppercase">S-CVI / Universal</p>
                    <p class="text-3xl font-black">${uaCVI.toFixed(3)}</p>
                </div>
                <div class="bg-slate-800 p-5 rounded-2xl text-center text-white">
                    <p class="text-slate-400 text-[10px] font-bold uppercase">Lynn Criteria</p>
                    <p class="text-3xl font-black">‚â• ${crit.toFixed(2)}</p>
                </div>
            `;

            document.getElementById('resBody').innerHTML = resHtml;
            document.getElementById('adviceList').innerHTML = `
                <li>‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç ${nExp} ‡∏Ñ‡∏ô: ‡∏Ñ‡πà‡∏≤ I-CVI ‡∏£‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ ${crit.toFixed(2)}</li>
                <li>‡∏Ñ‡πà‡∏≤ S-CVI/Ave ‡∏ó‡∏±‡πâ‡∏á‡∏â‡∏ö‡∏±‡∏ö‡∏Ñ‡∏ß‡∏£‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ 0.90 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏ñ‡∏∑‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á</li>
                <li>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${aveCVI >= 0.9 ? '<b>‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°</b>' : '<b class="text-red-600">‡∏Ñ‡∏ß‡∏£‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå</b>'}</li>
            `;
            showStep(3);
        }

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(finalData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "CVI_Report");
            XLSX.writeFile(wb, "CVI_Analysis_Result.xlsx");
        }
    </script>
</body>
</html>
